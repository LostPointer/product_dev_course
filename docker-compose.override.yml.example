# Docker Compose Override для Development режима
#
# Использование:
# 1. Скопируйте этот файл: cp docker-compose.override.yml.example docker-compose.override.yml
# 2. docker-compose автоматически загрузит этот файл при запуске
# 3. Для production используйте: docker-compose -f docker-compose.yml up (без override)
#
# Этот файл переопределяет настройки из основного docker-compose.yml для:
# - Hot-reload через volumes
# - Dev команды запуска
# - Dev stages из Dockerfile'ов
# - Дополнительные порты для отладки

version: "3.9"

services:
  # Experiment Service - Backend
  experiment-service:
    # Монтируем исходный код для hot-reload
    volumes:
      - ./projects/backend/services/experiment-service/src:/app/src:ro
      # Исключаем кэш Python для избежания конфликтов
      - /app/src/__pycache__
    # Используем watchfiles для автоматической перезагрузки при изменении кода
    command: >
      sh -c "
        if command -v watchfiles >/dev/null 2>&1; then
          watchfiles 'python -m experiment_service.main' --filter python ./src
        else
          python -m experiment_service.main
        fi
      "
    environment:
      - DEV_MODE=true
      - ENV=development
    # Дополнительные порты для отладки (если нужны)
    # ports:
    #   - "8002:8002"  # уже определено в основном compose

  # Auth Proxy - BFF
  auth-proxy:
    # Используем development stage из Dockerfile
    build:
      context: ./projects/frontend/apps/auth-proxy
      dockerfile: Dockerfile
      target: development
    # Монтируем исходный код для hot-reload
    volumes:
      - ./projects/frontend/apps/auth-proxy/src:/app/src
      - ./projects/frontend/apps/auth-proxy/tsconfig.json:/app/tsconfig.json
      # Исключаем node_modules и dist для избежания конфликтов
      - /app/node_modules
      - /app/dist
    # Используем dev команду (ts-node-dev с hot-reload)
    command: npm run dev
    environment:
      - NODE_ENV=development
      - DEV_MODE=true
    # Порты уже определены в основном compose

  # Experiment Portal - Frontend
  experiment-portal:
    # Используем development stage из Dockerfile
    build:
      context: ./projects/frontend/apps/experiment-portal
      dockerfile: Dockerfile
      target: development
    # Монтируем исходный код для hot-reload
    volumes:
      - ./projects/frontend/apps/experiment-portal/src:/app/src
      - ./projects/frontend/apps/experiment-portal/index.html:/app/index.html
      - ./projects/frontend/apps/experiment-portal/vite.config.ts:/app/vite.config.ts
      - ./projects/frontend/apps/experiment-portal/tsconfig.json:/app/tsconfig.json
      - ./projects/frontend/apps/experiment-portal/tsconfig.node.json:/app/tsconfig.node.json
      # Исключаем node_modules и dist
      - /app/node_modules
      - /app/dist
    # Используем Vite dev server с hot-reload
    command: npm run dev
    environment:
      - NODE_ENV=development
      - DEV_MODE=true
    # Vite dev server использует порт 3000
    ports:
      - "3000:3000"

  # PostgreSQL - открываем порт для локального доступа
  postgres:
    ports:
      - "5433:5432"  # Доступ к БД с хоста для отладки и миграций (5433 чтобы не конфликтовать с локальным PostgreSQL)

  # Redis (если используется)
  # redis:
  #   ports:
  #     - "6379:6379"  # Доступ к Redis с хоста

  # RabbitMQ (если используется)
  # rabbitmq:
  #   ports:
  #     - "5672:5672"      # AMQP порт
  #     - "15672:15672"    # Management UI

  # ============================================
  # Логирование (Grafana Loki + Alloy + Grafana)
  # Автоматически запускается в dev режиме
  # Конфигурационные файлы находятся в infrastructure/logging/
  # ============================================

  # Loki - система хранения и агрегации логов
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./infrastructure/logging/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - experiment-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Grafana Alloy - сборщик логов из Docker контейнеров
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infrastructure/logging/alloy.river:/etc/alloy/config.river:ro
    command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data /etc/alloy/config.river
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - experiment-network
    restart: unless-stopped
    ports:
      - "12345:12345"  # HTTP сервер для метрик и UI

  # Grafana - веб-интерфейс для визуализации логов
  grafana:
    image: grafana/grafana:10.0.0
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_AUTH_ANONYMOUS_ENABLED=${GRAFANA_ANONYMOUS_ENABLED:-false}
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3001}
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/logging/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infrastructure/logging/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - experiment-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  loki_data:
    name: ${LOKI_DATA_VOLUME:-experiment-loki-data}
  grafana_data:
    name: ${GRAFANA_DATA_VOLUME:-experiment-grafana-data}

