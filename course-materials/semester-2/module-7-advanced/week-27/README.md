# –ù–µ–¥–µ–ª—è 27: –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤

## –¶–µ–ª–∏ –Ω–µ–¥–µ–ª–∏
- –ü–æ–Ω—è—Ç—å —Ç–∏–ø—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò–∑—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –û—Å–≤–æ–∏—Ç—å Locust –∏ k6
- –ù–∞—É—á–∏—Ç—å—Å—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
- –ü–æ–Ω—è—Ç—å –∫–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å

### –ó–∞—á–µ–º –Ω—É–∂–Ω–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ?

**–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

**–¶–µ–ª–∏:**
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–∞–π—Ç–∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ (bottlenecks)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- ‚úÖ –°–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è –≤ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production

**–ë–µ–∑ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- ‚ùå –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
- ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–∞–¥–µ–Ω–∏—è –≤ production
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### –¢–∏–ø—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 1. Load Testing (–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –æ–∂–∏–¥–∞–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- –û–∂–∏–¥–∞–µ–º–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```
Load: [=====>     ] (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —É—Ä–æ–≤–Ω—è)
Time: |---------->
```

#### 2. Stress Testing (–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ —Ç–æ—á–∫—É –æ—Ç–∫–∞–∑–∞ —Å–∏—Å—Ç–µ–º—ã.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ù–∞–≥—Ä—É–∑–∫–∞ –≤—ã—à–µ –æ–∂–∏–¥–∞–µ–º–æ–π
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ –ø—Ä–µ–¥–µ–ª–∞
- –ü–æ–∏—Å–∫ —Ç–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞

```
Load: [===========>] (–¥–æ –ø—Ä–µ–¥–µ–ª–∞)
Time: |---------->
```

#### 3. Spike Testing (–ü–∏–∫–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Ä–µ–∑–∫–∏–π –≤—Å–ø–ª–µ—Å–∫ –Ω–∞–≥—Ä—É–∑–∫–∏.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –†–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏
- –ö–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```
Load: [     /|\    ] (—Ä–µ–∑–∫–∏–π –≤—Å–ø–ª–µ—Å–∫)
Time: |---------->
```

#### 4. Endurance Testing (–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (—á–∞—Å—ã/–¥–Ω–∏)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

```
Load: [=====>     ] (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
Time: |------------------------>
```

#### 5. Volume Testing (–û–±—ä–µ–º–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏

## –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ –∏–∑–º–µ—Ä—è–µ–º?

1. **Throughput (–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É (RPS)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É (TPS)

2. **Latency (–ó–∞–¥–µ—Ä–∂–∫–∞)**
   - Response time (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞)
   - P50, P95, P99 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏

3. **Error Rate (–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫)**
   - –ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫
   - –¢–∏–ø—ã –æ—à–∏–±–æ–∫ (5xx, 4xx, timeout)

4. **Resource Usage (–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)**
   - CPU usage
   - Memory usage
   - Network I/O
   - Database connections

5. **Concurrency (–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º)**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## Locust

### –ß—Ç–æ —Ç–∞–∫–æ–µ Locust?

**Locust** - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ Python.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ö–æ–¥ –Ω–∞ Python (–≥–∏–±–∫–æ—Å—Ç—å)
- ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- ‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
pip install locust
```

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```python
# locustfile.py
from locust import HttpUser, task, between

class ExperimentAPIUser(HttpUser):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Experiment API."""
    wait_time = between(1, 3)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (1-3 —Å–µ–∫)

    def on_start(self):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        # –õ–æ–≥–∏–Ω –∏–ª–∏ –¥—Ä—É–≥–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        response = self.client.post(
            "/api/v1/auth/login",
            json={"username": "test_user", "password": "password"}
        )
        self.token = response.json()["access_token"]
        self.client.headers = {"Authorization": f"Bearer {self.token}"}

    @task(3)  # –í–µ—Å –∑–∞–¥–∞—á–∏ (—á–∞—Å—Ç–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
    def get_experiments(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤."""
        self.client.get("/api/v1/experiments")

    @task(2)
    def get_experiment_by_id(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ ID."""
        experiment_id = 1
        self.client.get(f"/api/v1/experiments/{experiment_id}")

    @task(1)
    def create_experiment(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞."""
        self.client.post(
            "/api/v1/experiments",
            json={
                "name": "Test Experiment",
                "project_id": 1,
                "config": {}
            }
        )

    def on_stop(self):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        # Cleanup –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        pass
```

### –ó–∞–ø—É—Å–∫ Locust

```bash
# –ó–∞–ø—É—Å–∫ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
locust -f locustfile.py --host=http://localhost:8000

# –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:8089
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞:**
```bash
# –ó–∞–ø—É—Å–∫ –±–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (headless)
locust -f locustfile.py \
  --host=http://localhost:8000 \
  --users=100 \
  --spawn-rate=10 \
  --run-time=5m \
  --headless

# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫
# Master
locust -f locustfile.py --master

# Workers (–Ω–∞ –¥—Ä—É–≥–∏—Ö –º–∞—à–∏–Ω–∞—Ö)
locust -f locustfile.py --worker --master-host=<master-ip>
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á

```python
from locust import HttpUser, task, TaskSet

class ExperimentTasks(TaskSet):
    """–ì—Ä—É–ø–ø–∞ –∑–∞–¥–∞—á –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤."""

    @task(3)
    def list_experiments(self):
        self.client.get("/api/v1/experiments")

    @task(1)
    def create_experiment(self):
        self.client.post("/api/v1/experiments", json={...})

class UserTasks(TaskSet):
    """–ì—Ä—É–ø–ø–∞ –∑–∞–¥–∞—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""

    @task(2)
    def get_profile(self):
        self.client.get("/api/v1/users/me")

    tasks = {ExperimentTasks: 3, UserTasks: 1}  # –í–µ—Å–∞ –≥—Ä—É–ø–ø

class ExperimentAPIUser(HttpUser):
    tasks = [UserTasks]
    wait_time = between(1, 3)
```

#### Custom –∫–ª–∏–µ–Ω—Ç—ã

```python
from locust import User, task, events
import asyncio
import httpx

class AsyncHttpUser(User):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Locust."""
    abstract = True

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.client = httpx.AsyncClient(base_url=self.host)

    @task
    async def my_task(self):
        response = await self.client.get("/api/v1/experiments")
        # Locust –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤

```python
from locust import HttpUser, task
from locust.exception import StopUser

class ExperimentAPIUser(HttpUser):

    @task
    def get_experiments(self):
        with self.client.get(
            "/api/v1/experiments",
            catch_response=True
        ) as response:
            if response.status_code == 200:
                data = response.json()
                if len(data) > 0:
                    response.success()
                else:
                    response.failure("Empty response")
            elif response.status_code == 401:
                # –ü–µ—Ä–µ–ª–æ–≥–∏–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                self.login()
                response.failure("Unauthorized")
            else:
                response.failure(f"Status {response.status_code}")
```

#### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```python
import random
from locust import HttpUser, task

class ExperimentAPIUser(HttpUser):

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.experiment_ids = [1, 2, 3, 4, 5]
        self.project_ids = [1, 2, 3]

    @task
    def get_experiment(self):
        experiment_id = random.choice(self.experiment_ids)
        self.client.get(f"/api/v1/experiments/{experiment_id}")

    @task
    def create_experiment(self):
        project_id = random.choice(self.project_ids)
        self.client.post(
            "/api/v1/experiments",
            json={
                "name": f"Test Experiment {random.randint(1, 1000)}",
                "project_id": project_id
            }
        )
```

#### –°–æ–±—ã—Ç–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏

```python
from locust import events
from locust.runners import MasterRunner

@events.test_start.add_listener
def on_test_start(environment, **kwargs):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ç–µ—Å—Ç–∞."""
    print("Test started!")

@events.test_stop.add_listener
def on_test_stop(environment, **kwargs):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–µ—Å—Ç–∞."""
    print("Test stopped!")
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –∏ —Ç.–¥.

@events.request.add_listener
def on_request(request_type, name, response_time, response_length, exception, **kwargs):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞."""
    if exception:
        print(f"Request failed: {name}, Exception: {exception}")

@events.user_error.add_listener
def on_user_error(user_instance, exception, **kwargs):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    print(f"User error: {exception}")
```

## k6

### –ß—Ç–æ —Ç–∞–∫–æ–µ k6?

**k6** - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç Grafana Labs.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã –Ω–∞ JavaScript
- ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana/InfluxDB

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# macOS
brew install k6

# Linux
curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz
sudo mv k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

# Docker
docker pull grafana/k6
```

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```javascript
// load_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '30s', target: 50 },   // Ramp-up –¥–æ 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    { duration: '1m', target: 50 },     // –î–µ—Ä–∂–∏–º 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    { duration: '30s', target: 100 },    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 100
    { duration: '1m', target: 100 },     // –î–µ—Ä–∂–∏–º 100
    { duration: '30s', target: 0 },     // Ramp-down –¥–æ 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],  // 95% –∑–∞–ø—Ä–æ—Å–æ–≤ < 500ms
    http_req_failed: ['rate<0.01'],    // <1% –æ—à–∏–±–æ–∫
  },
};

const BASE_URL = 'http://localhost:8000';

export function setup() {
  // –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
  const loginRes = http.post(`${BASE_URL}/api/v1/auth/login`, JSON.stringify({
    username: 'test_user',
    password: 'password',
  }), {
    headers: { 'Content-Type': 'application/json' },
  });

  const token = loginRes.json('access_token');
  return { token };
}

export default function (data) {
  const params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
    },
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
  const experimentsRes = http.get(`${BASE_URL}/api/v1/experiments`, params);
  check(experimentsRes, {
    'status is 200': (r) => r.status === 200,
    'response has experiments': (r) => r.json().length > 0,
  });

  sleep(1);

  // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
  const createRes = http.post(
    `${BASE_URL}/api/v1/experiments`,
    JSON.stringify({
      name: `Test Experiment ${__VU}`,  // __VU - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      project_id: 1,
    }),
    {
      ...params,
      headers: {
        ...params.headers,
        'Content-Type': 'application/json',
      },
    }
  );

  check(createRes, {
    'create status is 201': (r) => r.status === 201,
  });

  sleep(1);
}

export function teardown(data) {
  // –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
  console.log('Test completed');
}
```

### –ó–∞–ø—É—Å–∫ k6

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
k6 run load_test.js

# –ó–∞–ø—É—Å–∫ —Å –≤—ã–≤–æ–¥–æ–º –≤ InfluxDB
k6 run --out influxdb=http://localhost:8086/k6 load_test.js

# –ó–∞–ø—É—Å–∫ —Å –æ–±–ª–∞–∫–æ–º Grafana
k6 cloud load_test.js
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ k6

#### –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```javascript
import { Trend, Counter, Rate } from 'k6/metrics';

const experimentCreationTime = new Trend('experiment_creation_time');
const experimentsCreated = new Counter('experiments_created_total');
const experimentCreationRate = new Rate('experiment_creation_success');

export default function (data) {
  const startTime = Date.now();

  const res = http.post(
    `${BASE_URL}/api/v1/experiments`,
    JSON.stringify({ name: 'Test', project_id: 1 }),
    { headers: { ... } }
  );

  const duration = Date.now() - startTime;
  experimentCreationTime.add(duration);

  if (res.status === 201) {
    experimentsCreated.add(1);
    experimentCreationRate.add(1);
  } else {
    experimentCreationRate.add(0);
  }
}
```

#### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è

```javascript
import { SharedArray } from 'k6/data';

const experiments = new SharedArray('experiments', function () {
  return JSON.parse(open('./experiments.json'));
});

export default function (data) {
  const experiment = experiments[__VU % experiments.length];
  http.get(`${BASE_URL}/api/v1/experiments/${experiment.id}`, params);
}
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∏ –∏ thresholds

```javascript
export const options = {
  thresholds: {
    // HTTP –º–µ—Ç—Ä–∏–∫–∏
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
    http_req_waiting: ['p(95)<300'],

    // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    experiment_creation_time: ['p(95)<200'],
    experiment_creation_success: ['rate>0.95'],

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–µ–≥–∞–º
    'http_req_duration{endpoint:/api/v1/experiments}': ['p(95)<300'],
    'http_req_duration{endpoint:/api/v1/runs}': ['p(95)<500'],
  },
};

export default function (data) {
  const res = http.get(
    `${BASE_URL}/api/v1/experiments`,
    { tags: { endpoint: '/api/v1/experiments' } }
  );

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
}
```

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö?

1. **Throughput (RPS/TPS)**
   - –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è?
   - –ï—Å—Ç—å –ª–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏?

2. **Latency (Response Time)**
   - P50, P95, P99 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏
   - –ï—Å—Ç—å –ª–∏ –≤—ã–±—Ä–æ—Å—ã?
   - –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏?

3. **Error Rate**
   - –ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫?
   - –ö–∞–∫–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫?
   - –ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –æ—à–∏–±–∫–∏?

4. **Resource Usage**
   - CPU, Memory, I/O
   - –£–∑–∫–∏–µ –º–µ—Å—Ç–∞ –≤ —Ä–µ—Å—É—Ä—Å–∞—Ö?

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Locust

```
Name                                                           # reqs      # fails  |     Avg     Min     Max  |  Median   req/s
----------------------------------------------------------------------------------------------------------------------------------------
GET /api/v1/experiments                                        5000        0(0.00%)  |     45     20     200  |     42    50.00
POST /api/v1/experiments                                       1000        5(0.50%)  |    120     50     500  |    110    10.00
GET /api/v1/experiments/1                                      2000        0(0.00%)  |     30     15     100  |     28    20.00
----------------------------------------------------------------------------------------------------------------------------------------
Total                                                          8000        5(0.06%)                                80.00 req/s
```

**–ê–Ω–∞–ª–∏–∑:**
- GET /experiments: —Ö–æ—Ä–æ—à–æ (–Ω–∏–∑–∫–∞—è latency, –Ω–µ—Ç –æ—à–∏–±–æ–∫)
- POST /experiments: –µ—Å—Ç—å –æ—à–∏–±–∫–∏ (0.5%), –≤—ã—Å–æ–∫–∞—è latency
- GET /experiments/:id: —Ö–æ—Ä–æ—à–æ

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ k6

```
     ‚úì status is 200
     ‚úì response has experiments
     ‚úì create status is 201

     checks.........................: 100.00% ‚úì 8000      ‚úó 0
     data_received..................: 2.5 MB  41 kB/s
     data_sent......................: 1.2 MB  20 kB/s
     http_req_duration..............: avg=45ms    min=20ms   med=42ms   max=200ms   p(90)=80ms   p(95)=100ms
     http_req_failed................: 0.06%   ‚úì 5         ‚úó 7995
     http_reqs......................: 8000   133.33/s
     iteration_duration.............: avg=1.5s   min=1.0s   med=1.4s   max=3.0s
     iterations....................: 8000   133.33/s
     vus............................: 100     min=1      max=100
     vus_max........................: 100     min=100    max=100
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### 1. –í—ã—Å–æ–∫–∞—è latency

**–ü—Ä–æ–±–ª–µ–º–∞:** P95 latency > 1s

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- N+1 –ø—Ä–æ–±–ª–µ–º–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã

**–†–µ—à–µ–Ω–∏—è:**
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- Connection pooling

#### 2. –í—ã—Å–æ–∫–∏–π error rate

**–ü—Ä–æ–±–ª–µ–º–∞:** >1% –æ—à–∏–±–æ–∫

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤
- –¢–∞–π–º–∞—É—Ç—ã
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è rate limiting

**–†–µ—à–µ–Ω–∏—è:**
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

#### 3. –ù–∏–∑–∫–∏–π throughput

**–ü—Ä–æ–±–ª–µ–º–∞:** RPS –º–µ–Ω—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –£–∑–∫–æ–µ –º–µ—Å—Ç–æ –≤ –∫–æ–¥–µ
- –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

**–†–µ—à–µ–Ω–∏—è:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤

### –ü—Ä–∏–º–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
POST /api/v1/experiments: avg=500ms, p95=800ms, errors=2%
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
# –ë—ã–ª–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
experiment = await create_experiment(data)
metrics = await init_metrics(experiment['id'])
resources = await allocate_resources(experiment['id'])

# –°—Ç–∞–ª–æ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
experiment = await create_experiment(data)
metrics, resources = await asyncio.gather(
    init_metrics(experiment['id']),
    allocate_resources(experiment['id'])
)
```

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
POST /api/v1/experiments: avg=150ms, p95=250ms, errors=0%
```

## Best Practices

### 1. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∞–ª–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

```python
# –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
stages = [
    {'duration': '1m', 'target': 10},   # –†–∞–∑–º–∏–Ω–∫–∞
    {'duration': '2m', 'target': 50},     # –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç
    {'duration': '5m', 'target': 100},    # –¶–µ–ª–µ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
]
```

### 2. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

```python
# ‚úÖ –•–û–†–û–®–û - —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
@task(10)  # –ß–∏—Ç–∞–µ–º —á–∞—â–µ
def get_experiment(self):
    ...

@task(2)   # –°–æ–∑–¥–∞–µ–º —Ä–µ–∂–µ
def create_experiment(self):
    ...
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```python
# –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–æ–≤
with open('experiment_ids.json') as f:
    self.experiment_ids = json.load(f)
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞

```python
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Prometheus –º–µ—Ç—Ä–∏–∫–∏ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞
# –°–º–æ—Ç—Ä–∏—Ç–µ CPU, Memory, Database connections
```

### 5. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

```python
# –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ç–µ—Å—Ç–æ–≤
# - –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
# - –ü–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
# - –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç

### Locust —Ç–µ—Å—Ç –¥–ª—è Experiment Service

```python
# locustfile.py
from locust import HttpUser, task, between, events
import random
import json

class ExperimentAPIUser(HttpUser):
    wait_time = between(1, 3)

    def on_start(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        # –õ–æ–≥–∏–Ω
        response = self.client.post(
            "/api/v1/auth/login",
            json={"username": "test_user", "password": "password"}
        )
        if response.status_code == 200:
            self.token = response.json()["access_token"]
            self.client.headers = {"Authorization": f"Bearer {self.token}"}

            # –ó–∞–≥—Ä—É–∂–∞–µ–º ID —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
            exp_response = self.client.get("/api/v1/experiments")
            if exp_response.status_code == 200:
                experiments = exp_response.json()
                self.experiment_ids = [e['id'] for e in experiments[:10]]
            else:
                self.experiment_ids = [1, 2, 3, 4, 5]
        else:
            # Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            self.experiment_ids = [1, 2, 3, 4, 5]

    @task(5)
    def list_experiments(self):
        """–°–ø–∏—Å–æ–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ (—á–∞—Å—Ç–æ —á–∏—Ç–∞–µ–º)."""
        with self.client.get(
            "/api/v1/experiments",
            catch_response=True,
            name="GET /experiments"
        ) as response:
            if response.status_code == 200:
                response.success()
            else:
                response.failure(f"Status {response.status_code}")

    @task(3)
    def get_experiment(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ ID."""
        experiment_id = random.choice(self.experiment_ids)
        with self.client.get(
            f"/api/v1/experiments/{experiment_id}",
            catch_response=True,
            name="GET /experiments/:id"
        ) as response:
            if response.status_code == 200:
                response.success()
            else:
                response.failure(f"Status {response.status_code}")

    @task(1)
    def create_experiment(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (—Ä–µ–∂–µ —Å–æ–∑–¥–∞–µ–º)."""
        with self.client.post(
            "/api/v1/experiments",
            json={
                "name": f"Load Test Experiment {random.randint(1, 10000)}",
                "project_id": 1,
                "config": {}
            },
            catch_response=True,
            name="POST /experiments"
        ) as response:
            if response.status_code == 201:
                data = response.json()
                if 'id' in data:
                    self.experiment_ids.append(data['id'])
                    response.success()
                else:
                    response.failure("No ID in response")
            else:
                response.failure(f"Status {response.status_code}")
```

### k6 —Ç–µ—Å—Ç –¥–ª—è Experiment Service

```javascript
// load_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

const errorRate = new Rate('errors');
const experimentCreationTime = new Trend('experiment_creation_time');

export const options = {
  stages: [
    { duration: '1m', target: 50 },
    { duration: '3m', target: 50 },
    { duration: '1m', target: 100 },
    { duration: '3m', target: 100 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
    errors: ['rate<0.01'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:8000';

export function setup() {
  const loginRes = http.post(
    `${BASE_URL}/api/v1/auth/login`,
    JSON.stringify({
      username: 'test_user',
      password: 'password',
    }),
    { headers: { 'Content-Type': 'application/json' } }
  );

  if (loginRes.status !== 200) {
    throw new Error(`Login failed: ${loginRes.status}`);
  }

  return {
    token: loginRes.json('access_token'),
  };
}

export default function (data) {
  const params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
    },
    tags: { name: 'ExperimentAPI' },
  };

  // –°–ø–∏—Å–æ–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
  const listRes = http.get(`${BASE_URL}/api/v1/experiments`, params);
  const listSuccess = check(listRes, {
    'list status is 200': (r) => r.status === 200,
    'list response time < 500ms': (r) => r.timings.duration < 500,
  });
  errorRate.add(!listSuccess);
  sleep(1);

  // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
  const createStart = Date.now();
  const createRes = http.post(
    `${BASE_URL}/api/v1/experiments`,
    JSON.stringify({
      name: `Load Test Experiment ${__VU}-${__ITER}`,
      project_id: 1,
      config: {},
    }),
    {
      ...params,
      headers: {
        ...params.headers,
        'Content-Type': 'application/json',
      },
    }
  );
  const createDuration = Date.now() - createStart;
  experimentCreationTime.add(createDuration);

  const createSuccess = check(createRes, {
    'create status is 201': (r) => r.status === 201,
    'create response time < 500ms': (r) => r.timings.duration < 500,
  });
  errorRate.add(!createSuccess);
  sleep(1);
}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏
- [Locust Documentation](https://docs.locust.io/)
- [k6 Documentation](https://k6.io/docs/)
- [Load Testing Best Practices](https://k6.io/docs/test-types/)

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- [Apache JMeter](https://jmeter.apache.org/) - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
- [Artillery](https://www.artillery.io/) - –µ—â–µ –æ–¥–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
- [wrk](https://github.com/wg/wrk) - –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

### –°—Ç–∞—Ç—å–∏
- [Load Testing Guide](https://k6.io/docs/test-types/load-testing/)
- [Performance Testing Strategies](https://www.softwaretestinghelp.com/performance-testing-tutorial/)

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

1. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Load Testing –∏ Stress Testing?
2. –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–∂–Ω—ã –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏?
3. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Locust, –∞ –∫–æ–≥–¥–∞ k6?
4. –ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å P95 latency?
5. –ö–∞–∫–∏–µ —Ç–∏–ø—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –≤–æ–∑–º–æ–∂–Ω—ã –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?

## –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è

–ù–∞ [–ù–µ–¥–µ–ª–µ 28](../week-28/README.md) –Ω–∞—á–∏–Ω–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫! üöÄ

---

**–£–¥–∞—á–∏ —Å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º! üí™**

