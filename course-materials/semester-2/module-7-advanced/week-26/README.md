# –ù–µ–¥–µ–ª—è 26: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö

## –¶–µ–ª–∏ –Ω–µ–¥–µ–ª–∏
- –ü–æ–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö
- –ò–∑—É—á–∏—Ç—å Prometheus –∏ –º–µ—Ç—Ä–∏–∫–∏
- –û—Å–≤–æ–∏—Ç—å Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- –ù–∞—É—á–∏—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å alerting
- –ü–æ–Ω—è—Ç—å –∫–∞–∫ —Å–æ–±–∏—Ä–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏

## –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥?

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.

**–ó–∞–¥–∞—á–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ —Å—Ç–∞–Ω—É—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏
- ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

**–ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚ùå –ù–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç
- ‚ùå –°–ª–æ–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## Prometheus

### –ß—Ç–æ —Ç–∞–∫–æ–µ Prometheus?

**Prometheus** - —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ alerting —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ë–î.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Pull-based –º–æ–¥–µ–ª—å (Prometheus —Å–∞–º —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏)
- –ú–Ω–æ–≥–æ–º–µ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–º–µ—Ç–∫–∏/labels)
- PromQL - —è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Prometheus Server
  ‚îú‚îÄ‚îÄ Time Series Database
  ‚îú‚îÄ‚îÄ Data Retrieval (scraping)
  ‚îú‚îÄ‚îÄ PromQL Engine
  ‚îî‚îÄ‚îÄ Alertmanager Integration

Exporters / Instrumentation
  ‚îú‚îÄ‚îÄ Application Metrics
  ‚îú‚îÄ‚îÄ System Metrics
  ‚îî‚îÄ‚îÄ Custom Metrics
```

### –¢–∏–ø—ã –º–µ—Ç—Ä–∏–∫

#### 1. Counter

**Counter** - –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –æ—à–∏–±–æ–∫, —Å–æ–±—ã—Ç–∏–π.

```python
from prometheus_client import Counter

http_requests_total = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

# –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç
http_requests_total.labels(method='GET', endpoint='/api/experiments', status='200').inc()
```

#### 2. Gauge

**Gauge** - –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –∏ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏.

```python
from prometheus_client import Gauge

active_requests = Gauge(
    'http_active_requests',
    'Active HTTP requests',
    ['method', 'endpoint']
)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è
active_requests.labels(method='GET', endpoint='/api/experiments').set(5)

# –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç/–¥–µ–∫—Ä–µ–º–µ–Ω—Ç
active_requests.labels(method='GET', endpoint='/api/experiments').inc()
active_requests.labels(method='GET', endpoint='/api/experiments').dec()
```

#### 3. Histogram

**Histogram** - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ buckets.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤, —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤.

```python
from prometheus_client import Histogram

request_duration = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint'],
    buckets=[0.1, 0.5, 1.0, 2.0, 5.0]  # Buckets –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
)

# –ò–∑–º–µ—Ä–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
with request_duration.labels(method='GET', endpoint='/api/experiments').time():
    # –í–∞—à –∫–æ–¥
    await process_request()

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
request_duration.labels(method='GET', endpoint='/api/experiments').observe(0.25)
```

#### 4. Summary

**Summary** - –ø–æ—Ö–æ–∂ –Ω–∞ Histogram, –Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç –∫–≤–∞–Ω—Ç–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω—ã —Ç–æ—á–Ω—ã–µ –∫–≤–∞–Ω—Ç–∏–ª–∏ –±–µ–∑ buckets.

```python
from prometheus_client import Summary

request_latency = Summary(
    'http_request_latency_seconds',
    'HTTP request latency',
    ['method', 'endpoint']
)

# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Histogram
with request_latency.labels(method='GET', endpoint='/api/experiments').time():
    await process_request()
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Prometheus –≤ aiohttp

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```python
# experiment-service/main.py
from prometheus_client import Counter, Histogram, Gauge, generate_latest
from prometheus_client import CONTENT_TYPE_LATEST
from aiohttp import web
import time

# –ú–µ—Ç—Ä–∏–∫–∏
http_requests_total = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

http_request_duration = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint'],
    buckets=[0.1, 0.5, 1.0, 2.0, 5.0, 10.0]
)

http_active_requests = Gauge(
    'http_active_requests',
    'Active HTTP requests',
    ['method', 'endpoint']
)

# Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
@web.middleware
async def metrics_middleware(request, handler):
    """Middleware –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫."""
    method = request.method
    endpoint = request.match_info.route_info.get_info().get('formatter', request.path)

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    http_active_requests.labels(method=method, endpoint=endpoint).inc()

    start_time = time.time()

    try:
        response = await handler(request)

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        http_requests_total.labels(
            method=method,
            endpoint=endpoint,
            status=str(response.status)
        ).inc()

        return response

    except Exception as e:
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        http_requests_total.labels(
            method=method,
            endpoint=endpoint,
            status='500'
        ).inc()
        raise

    finally:
        # –ò–∑–º–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        duration = time.time() - start_time
        http_request_duration.labels(
            method=method,
            endpoint=endpoint
        ).observe(duration)

        # –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        http_active_requests.labels(method=method, endpoint=endpoint).dec()

# Endpoint –¥–ª—è Prometheus
async def metrics_handler(request):
    """Endpoint –¥–ª—è Prometheus scraping."""
    return web.Response(
        body=generate_latest(),
        content_type=CONTENT_TYPE_LATEST
    )

app = web.Application(middlewares=[metrics_middleware])
app.router.add_get('/metrics', metrics_handler)
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```python
# experiment-service/metrics.py
from prometheus_client import Counter, Histogram, Gauge

# –ú–µ—Ç—Ä–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db_query_duration = Histogram(
    'db_query_duration_seconds',
    'Database query duration',
    ['operation', 'table']
)

db_connections_active = Gauge(
    'db_connections_active',
    'Active database connections'
)

# –ú–µ—Ç—Ä–∏–∫–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
experiments_created_total = Counter(
    'experiments_created_total',
    'Total experiments created',
    ['project_id']
)

experiment_runs_total = Counter(
    'experiment_runs_total',
    'Total experiment runs',
    ['experiment_id', 'status']
)

# –ú–µ—Ç—Ä–∏–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
external_api_duration = Histogram(
    'external_api_duration_seconds',
    'External API call duration',
    ['service', 'endpoint']
)

external_api_errors_total = Counter(
    'external_api_errors_total',
    'Total external API errors',
    ['service', 'endpoint', 'status_code']
)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ –∫–æ–¥–µ

```python
# experiment-service/handlers/experiments.py
from experiment_service.metrics import (
    experiments_created_total,
    db_query_duration,
    external_api_duration
)
import time

async def create_experiment_handler(request: web.Request):
    """–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏."""
    # –ò–∑–º–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    start = time.time()
    experiment = await experiment_service.create(await request.json())
    db_query_duration.labels(
        operation='create',
        table='experiments'
    ).observe(time.time() - start)

    # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
    experiments_created_total.labels(
        project_id=str(experiment['project_id'])
    ).inc()

    return web.json_response(experiment, status=201)

async def call_external_service(service_url: str, endpoint: str):
    """–í—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏."""
    start = time.time()

    try:
        async with httpx.AsyncClient() as client:
            response = await client.get(f"{service_url}{endpoint}")
            response.raise_for_status()

            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—ã–∑–æ–≤
            external_api_duration.labels(
                service=service_url,
                endpoint=endpoint
            ).observe(time.time() - start)

            return response.json()

    except httpx.HTTPError as e:
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        external_api_errors_total.labels(
            service=service_url,
            endpoint=endpoint,
            status_code=str(getattr(e, 'status_code', 'unknown'))
        ).inc()
        raise
```

## Docker Compose –¥–ª—è Prometheus

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus

```yaml
# docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  prometheus_data:
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus

```yaml
# prometheus/prometheus.yml
global:
  scrape_interval: 15s  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
  evaluation_interval: 15s  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∞–≤–∏–ª alerting

scrape_configs:
  # Experiment Service
  - job_name: 'experiment-service'
    static_configs:
      - targets: ['experiment-service:8000']
        labels:
          service: 'experiment-service'
          environment: 'development'

  # Metrics Service
  - job_name: 'metrics-service'
    static_configs:
      - targets: ['metrics-service:8002']
        labels:
          service: 'metrics-service'
          environment: 'development'

  # Resource Service
  - job_name: 'resource-service'
    static_configs:
      - targets: ['resource-service:8001']
        labels:
          service: 'resource-service'
          environment: 'development'

  # Prometheus —Å–∞–º
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

**Prometheus UI:** http://localhost:9090

## Grafana

### –ß—Ç–æ —Ç–∞–∫–æ–µ Grafana?

**Grafana** - –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–æ–≤.

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –î–∞—à–±–æ—Ä–¥—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
- –ê–ª–µ—Ä—Ç—ã
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus, Elasticsearch, Jaeger

### Docker Compose –¥–ª—è Grafana

```yaml
# docker-compose.yml
services:
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  grafana_data:
```

**Grafana UI:** http://localhost:3000 (admin/admin)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```yaml
# grafana/provisioning/datasources/prometheus.yml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
```

### –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞

**–ü—Ä–∏–º–µ—Ä –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è HTTP –º–µ—Ç—Ä–∏–∫:**

```json
{
  "dashboard": {
    "title": "HTTP Metrics Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "Request Duration (p95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "p95 {{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "Active Requests",
        "targets": [
          {
            "expr": "http_active_requests",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      }
    ]
  }
}
```

## PromQL (Prometheus Query Language)

### –ë–∞–∑–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```promql
# –ü—Ä–æ—Å—Ç–∞—è –º–µ—Ç—Ä–∏–∫–∞
http_requests_total

# –§–∏–ª—å—Ç—Ä –ø–æ labels
http_requests_total{method="GET", status="200"}

# Rate (–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏)
rate(http_requests_total[5m])

# Increase (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞ –ø–µ—Ä–∏–æ–¥)
increase(http_requests_total[1h])

# Sum (—Å—É–º–º–∞)
sum(http_requests_total) by (method)

# Average (—Å—Ä–µ–¥–Ω–µ–µ)
avg(http_request_duration_seconds) by (endpoint)

# Max/Min
max(http_request_duration_seconds) by (endpoint)
min(http_request_duration_seconds) by (endpoint)

# Quantile –¥–ª—è Histogram
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# Percentage –æ—à–∏–±–æ–∫
sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```promql
# Requests per second –ø–æ endpoint
sum(rate(http_requests_total[5m])) by (endpoint)

# P95 latency –ø–æ endpoint
histogram_quantile(0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint)
)

# Error rate –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
sum(rate(http_requests_total{status=~"5.."}[5m])) /
sum(rate(http_requests_total[5m])) * 100

# Active connections
db_connections_active

# Top 10 endpoints –ø–æ requests
topk(10, sum(rate(http_requests_total[5m])) by (endpoint))
```

## Alerting

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alertmanager

```yaml
# docker-compose.yml
services:
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
    depends_on:
      - prometheus
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alertmanager

```yaml
# alertmanager/alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'

    - match:
        severity: warning
      receiver: 'warning-alerts'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://notification-service:8000/webhooks/alerts'

  - name: 'critical-alerts'
    webhook_configs:
      - url: 'http://notification-service:8000/webhooks/alerts/critical'

  - name: 'warning-alerts'
    webhook_configs:
      - url: 'http://notification-service:8000/webhooks/alerts/warning'
```

### –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ –≤ Prometheus

```yaml
# prometheus/alerts.yml
groups:
  - name: http_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) /
          sum(rate(http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint)
          ) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "P95 latency is {{ $value }}s for {{ $labels.endpoint }}"

      - alert: HighRequestRate
        expr: |
          sum(rate(http_requests_total[5m])) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request rate"
          description: "Request rate is {{ $value }} req/s"

      - alert: ServiceDown
        expr: up{job=~".*-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "{{ $labels.job }} is down"

  - name: database_alerts
    interval: 30s
    rules:
      - alert: TooManyDBConnections
        expr: db_connections_active > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Too many database connections"
          description: "{{ $value }} active connections"
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ alerts –∫ Prometheus

```yaml
# prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

# ... scrape_configs ...

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# Load alerting rules
rule_files:
  - 'alerts.yml'
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã

### Node Exporter

**Node Exporter** - –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫).

```yaml
# docker-compose.yml
services:
  node-exporter:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ Prometheus

```yaml
# prometheus/prometheus.yml
scrape_configs:
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã

```promql
# CPU usage
100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# Memory usage
node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes

# Disk usage
100 - ((node_filesystem_avail_bytes{mountpoint="/"} * 100) / node_filesystem_size_bytes{mountpoint="/"})

# Network traffic
rate(node_network_receive_bytes_total[5m])
rate(node_network_transmit_bytes_total[5m])
```

## Best Practices

### 1. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

```python
# ‚úÖ –•–û–†–û–®–û - –ø—Ä–µ—Ñ–∏–∫—Å, —Å—É—Ñ—Ñ–∏–∫—Å –µ–¥–∏–Ω–∏—Ü
http_requests_total
http_request_duration_seconds
db_connections_active

# ‚ùå –ü–õ–û–•–û
requests
duration
connections
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ labels –ø—Ä–∞–≤–∏–ª—å–Ω–æ

```python
# ‚úÖ –•–û–†–û–®–û - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ label –∑–Ω–∞—á–µ–Ω–∏–π
http_requests_total{method="GET", endpoint="/api/experiments", status="200"}

# ‚ùå –ü–õ–û–•–û - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
http_requests_total{user_id="123", request_id="abc"}
```

### 3. –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—Ä–¥–∏–Ω–∞–ª–æ–º

**–ö–∞—Ä–¥–∏–Ω–∞–ª** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π labels.

```python
# ‚ùå –ü–õ–û–•–û - –≤—ã—Å–æ–∫–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
requests_total{user_id=unique_id}  # –¢—ã—Å—è—á–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö user_id

# ‚úÖ –•–û–†–û–®–û - –Ω–∏–∑–∫–∞—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å
requests_total{status="200"}  # –í—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π status
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –º–µ—Ç—Ä–∏–∫–∏

```python
# Counter –¥–ª—è —Å–æ–±—ã—Ç–∏–π
requests_total.inc()

# Gauge –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
active_connections.set(10)

# Histogram –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
request_duration.observe(0.5)
```

### 5. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º endpoint

```python
# –û—Ç–¥–µ–ª—å–Ω—ã–π endpoint –¥–ª—è –º–µ—Ç—Ä–∏–∫
app.router.add_get('/metrics', metrics_handler)
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
experiment-service/
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ metrics.py
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ experiments.py
‚îî‚îÄ‚îÄ prometheus/
    ‚îî‚îÄ‚îÄ prometheus.yml
```

### main.py —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

```python
# experiment-service/main.py
from aiohttp import web
from experiment_service.metrics import setup_metrics

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ—Ç—Ä–∏–∫
setup_metrics()

app = web.Application(middlewares=[metrics_middleware])
app.router.add_get('/metrics', metrics_handler)

# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ routes ...
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏
- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)
- [PromQL Guide](https://prometheus.io/docs/prometheus/latest/querying/basics/)

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- [Prometheus UI](http://localhost:9090)
- [Grafana UI](http://localhost:3000)
- [PromQL Cheat Sheet](https://promlabs.com/promql-cheat-sheet/)

### –°—Ç–∞—Ç—å–∏
- [Prometheus Best Practices](https://prometheus.io/docs/practices/)
- [Monitoring Microservices](https://www.monitoring.dev/)

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

1. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Counter, Gauge –∏ Histogram?
2. –ß—Ç–æ —Ç–∞–∫–æ–µ PromQL –∏ –¥–ª—è —á–µ–≥–æ –æ–Ω –Ω—É–∂–µ–Ω?
3. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –≤ Prometheus?
4. –ß—Ç–æ —Ç–∞–∫–æ–µ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫ –∏ –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?
5. –ö–∞–∫ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Grafana?

## –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è

–ù–∞ [–ù–µ–¥–µ–ª–µ 27](../week-27/README.md) –∏–∑—É—á–∏–º –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Locust, k6 –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏! üöÄ

---

**–£–¥–∞—á–∏ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º! üìä**

