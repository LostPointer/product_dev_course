# Docker Compose конфигурация для стека логирования (Loki + Alloy + Grafana)
#
# Использование:
#   cd infrastructure/logging
#   docker-compose -f docker-compose.yml up -d
#   или из корня проекта:
#   docker-compose -f ../docker-compose.yml -f docker-compose.yml up -d
#
# Доступ:
#   Grafana: http://localhost:3001 (admin/admin) - веб-интерфейс для просмотра логов
#   Loki API: http://localhost:3100 - API сервер (используйте Grafana для просмотра)

version: "3.9"

services:
  # Loki - система хранения и агрегации логов
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - experiment-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Grafana Alloy - сборщик логов из Docker контейнеров
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./alloy.river:/etc/alloy/config.river:ro
    command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data /etc/alloy/config.river
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - experiment-network
    restart: unless-stopped
    ports:
      - "12345:12345"  # HTTP сервер для метрик и UI

  # Grafana - веб-интерфейс для визуализации логов
  grafana:
    image: grafana/grafana:10.0.0
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_AUTH_ANONYMOUS_ENABLED=${GRAFANA_ANONYMOUS_ENABLED:-false}
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3001}
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - experiment-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Named volumes для персистентности данных
volumes:
  loki_data:
    name: ${LOKI_DATA_VOLUME:-experiment-loki-data}
  grafana_data:
    name: ${GRAFANA_DATA_VOLUME:-experiment-grafana-data}

# Используем ту же сеть, что и основной docker-compose.yml
# Docker Compose автоматически подключит контейнеры к одной сети, если имя совпадает
networks:
  experiment-network:
    name: ${DOCKER_NETWORK_NAME:-experiment-tracking-network}
    driver: bridge
