# Схема подключения RC Vehicle

## Общая архитектура

```
┌─────────────┐         UART            ┌─────────────┐
│   ESP32-C3  │◄───────────────────────►│    RP2040   │
│  (Wi-Fi AP) │  115200 baud            │ (Controller)│
└─────────────┘                         └─────────────┘
      │                                        │
      │                                        ├──► PWM GPIO2 ──► ESC (Throttle)
      │                                        ├──► PWM GPIO3 ──► Servo (Steering)
      │                                        ├──► GPIO4 ──► RC Receiver CH1 (Throttle)
      │                                        ├──► GPIO5 ──► RC Receiver CH2 (Steering)
      │                                        ├──► SPI GPIO6–9 ──► MPU-6050/MPU-6500 (IMU)
      │                                        │
      └──► Wi-Fi AP (для веб-интерфейса)
```

## Детальная схема подключений

### 1. ESP32-C3

**Питание:**
- `5V` или `3V3` → от BEC 5V (через стабилизатор на плате) или 3.3V
- `GND` → общая земля

**UART к RP2040 (UART1 на ESP32-C3):**
- `GPIO4 (TX)` → `GPIO1 (RX)` на RP2040
- `GPIO5 (RX)` → `GPIO0 (TX)` на RP2040
- `GND` → общая земля

**Примечание:** ESP32-C3 питается от 3.3V; платы с USB часто имеют встроенный стабилизатор и питание от 5V.

### 2. Raspberry Pi Pico (RP2040)

**Питание:**
- `VSYS` или `VBUS` → 5V от BEC (через стабилизатор на плате Pico)
- `GND` → общая земля
- `3V3` → выход стабилизатора (для внешних компонентов)

**UART к ESP32-C3:**
- `GPIO0 (UART0 TX)` → `GPIO5 (RX)` на ESP32-C3
- `GPIO1 (UART0 RX)` → `GPIO4 (TX)` на ESP32-C3
- `GND` → общая земля

**PWM выходы (50 Hz, 1-2 мс):**
- `GPIO2 (PWM)` → Signal вход ESC (Throttle)
- `GPIO3 (PWM)` → Signal вход Servo (Steering)
- `GND` → общая земля с ESC/Servo

**RC-in входы (чтение PWM с приёмника):**
- `GPIO4` → Signal канал CH1 (Throttle) с RC приёмника
- `GPIO5` → Signal канал CH2 (Steering) с RC приёмника
- `GND` → общая земля с RC приёмником

**⚠️ ВАЖНО:** Если RC приёмник выдаёт 5V логику, используйте делители напряжения:
- Резистор 10kΩ между Signal и GPIO
- Резистор 20kΩ между GPIO и GND
- Или используйте level-shifter 5V→3.3V

**SPI к MPU-6050 / MPU-6500 (IMU)** — в прошивке используется **только SPI** (`firmware/common/mpu6050_spi.cpp`):

| RP2040       | MPU-6050/MPU-6500 | Назначение        |
|--------------|-------------------|-------------------|
| GPIO8 (CS)   | NCS / CS          | Chip Select       |
| GPIO6 (SCK)  | SCLK              | Тактирование SPI |
| GPIO7 (MOSI) | MOSI              | Данные к датчику  |
| GPIO9 (MISO) | MISO              | Данные от датчика |
| 3V3          | VCC               | Питание 3.3 V     |
| GND          | GND               | Земля             |

Конфигурация пинов: `firmware/rp2040/main/config.hpp` (SPI_CS_PIN, SPI_SCK_PIN, SPI_MOSI_PIN, SPI_MISO_PIN).

### 3. MPU-6050 / MPU-6500 (IMU) — по SPI

В коде датчик подключён **по SPI** (драйвер `Mpu6050Spi`). I2C в прошивке не используется.

#### RP2040 (Pico)

| MPU-6050 / MPU-6500 | RP2040    | Назначение        |
|--------------------|-----------|-------------------|
| VCC                | 3V3       | Питание 3.3 V     |
| GND                | GND       | Земля             |
| NCS / CS           | GPIO8     | Chip Select       |
| SCLK               | GPIO6     | SPI SCK           |
| MOSI               | GPIO7     | SPI MOSI          |
| MISO               | GPIO9     | SPI MISO          |

#### STM32 (Blue Pill / Black Pill / G4)

| MPU-6050 / MPU-6500 | STM32 (SPI2) | Назначение        |
|--------------------|--------------|-------------------|
| VCC                | 3V3          | Питание           |
| GND                | GND          | Земля             |
| NCS / CS           | PB12         | Chip Select       |
| SCLK               | PB13 (SCK)   | Тактирование SPI  |
| MISO               | PB14         | Данные от датчика |
| MOSI               | PB15         | Данные к датчику  |

Пины STM32: `firmware/stm32/main/board_pins.hpp`.

#### Breakout «9250/9255/6500/6555» (одна колодка выводов)

У таких модулей подписи на плате **I2C/SPI в одном ряду**. Для **SPI** используйте соответствие:

| Надпись на плате | В режиме SPI | RP2040 | STM32 |
|------------------|--------------|--------|--------|
| VCC              | Питание      | 3V3    | 3V3    |
| GND              | Земля        | GND    | GND    |
| **SCL / SCLK**   | Такт SPI     | GPIO6  | PB13   |
| **SDA / SDI**    | MOSI (вход данных датчика) | GPIO7 | PB15   |
| EDA              | —            | не подключать | —   |
| ECL              | —            | не подключать | —   |
| **ADO / SDO**    | MISO (выход данных датчика) | GPIO9 | PB14   |
| INT              | Прерывание   | по желанию | —   |
| **NCS**          | Chip Select  | GPIO8  | PB12   |
| FSYNC            | Синхронизация| по желанию | —   |

- **SDI** = Serial Data Input = **MOSI** (контроллер шлёт, датчик принимает).  
- **SDO** = Serial Data Output = **MISO** (датчик шлёт, контроллер принимает).

Минимум для работы по SPI: **VCC, GND, SCL/SCLK, SDA/SDI, ADO/SDO, NCS**. Остальные выводы можно не подключать.

**Важно:**
- Питание **только 3.3 V** (2.4–3.6 V по даташиту). Не подавать 5 V на VCC (если на модуле есть свой стабилизатор — смотрите маркировку).
- **MPU-6500:** WHO_AM_I = **0x70** (в прошивке уже учтён вместе с 0x68).
- Частота SPI в конфиге: 1 MHz.

### 4. RC Приёмник (Himoto 2.4GHz 4CH)

**Подключение:**
- `CH1 (Signal)` → GPIO4 на RP2040 (через делитель, если 5V)
- `CH2 (Signal)` → GPIO5 на RP2040 (через делитель, если 5V)
- `+` → 5V от BEC (если требуется питание приёмника)
- `-` → GND

**Примечание:** RC приёмник обычно питается от BEC или батареи отдельно.

### 5. ESC (Electronic Speed Controller)

**Подключение:**
- `Signal` → GPIO2 (PWM) на RP2040
- `+` → 5V (обычно не используется, ESC питается от батареи)
- `-` → GND

**Примечание:** ESC питается напрямую от батареи (обычно 2S LiPo, 7.4V).

### 6. Servo (Рулевой сервопривод)

**Подключение:**
- `Signal` → GPIO3 (PWM) на RP2040
- `+` → 5V от BEC
- `-` → GND

### 7. Питание (BEC)

**Подключение:**
- `Input` → Батарея 2S LiPo (7.4V)
- `Output 5V` →
  - ESP32-C3 (5V — если плата с линейным стабилизатором)
  - RP2040 (VSYS/VBUS)
  - Servo (+)
  - RC приёмник (если требуется)
- `GND` → общая земля всех компонентов

**Конденсаторы для стабилизации:**
- 470-1000µF электролитический на шине 5V
- 0.1µF керамический параллельно

## Таблица подключений (краткая)

| Компонент | Контакт | RP2040/ESP32-C3 | Примечание |
|-----------|---------|-----------------|------------|
| ESP32-C3 | GPIO4 (TX) | RP2040 GPIO1 (RX) | UART |
| ESP32-C3 | GPIO5 (RX) | RP2040 GPIO0 (TX) | UART |
| ESC | Signal | RP2040 GPIO2 | PWM, 50Hz |
| Servo | Signal | RP2040 GPIO3 | PWM, 50Hz |
| RC RX | CH1 | RP2040 GPIO4 | Через делитель если 5V |
| RC RX | CH2 | RP2040 GPIO5 | Через делитель если 5V |
| MPU-6050/MPU-6500 | NCS | RP2040 GPIO8 | SPI CS |
| MPU-6050/MPU-6500 | SCK | RP2040 GPIO6 | SPI SCK |
| MPU-6050/MPU-6500 | MOSI | RP2040 GPIO7 | SPI MOSI |
| MPU-6050/MPU-6500 | MISO | RP2040 GPIO9 | SPI MISO |
| MPU-6050/MPU-6500 | VCC | RP2040 3V3 | Питание |
| Все | GND | Общая земля | ⚠️ Важно! |

## Делитель напряжения для RC-in (если нужно)

Если RC приёмник выдаёт 5V логику, а RP2040 работает на 3.3V:

```
RC Signal (5V) ──[10kΩ]──┬── GPIO4/GPIO5 (3.3V max)
                          │
                         [20kΩ]
                          │
                         GND
```

Формула: Vout = Vin × R2/(R1+R2) = 5V × 20k/(10k+20k) = 3.33V ✓

## Порядок подключения (рекомендуемый)

1. **Питание:**
   - Подключить BEC к батарее
   - Проверить выход 5V мультиметром
   - Подключить конденсаторы на шину 5V

2. **Микроконтроллеры:**
   - Подключить ESP32-C3 к 3.3V/5V и GND (в зависимости от платы)
   - Подключить RP2040 к 5V и GND
   - Проверить, что оба работают (LED индикация)

3. **UART связь:**
   - Подключить TX→RX между ESP32 и RP2040
   - Подключить общую землю

4. **IMU:**
   - Подключить MPU-6050/MPU-6500 по SPI (RP2040: GPIO6–9; STM32: PB12–PB15)
   - Подключить питание 3.3V

5. **RC приёмник:**
   - Подключить сигналы через делители (если нужно)
   - Подключить питание (если требуется)

6. **Исполнительные устройства:**
   - Подключить ESC к GPIO2
   - Подключить Servo к GPIO3
   - ⚠️ Безопасность: убедитесь, что failsafe работает перед тестами!

## Проверка подключений

1. **Питание:**
   - Проверить 5V на всех точках питания
   - Проверить 3.3V на RP2040 и MPU-6050

2. **UART:**
   - Проверить связь между ESP32 и RP2040 (логи в Serial Monitor)

3. **SPI (IMU):**
   - Проверить инициализацию IMU (WHO_AM_I: MPU-6050 = 0x68, MPU-6500 = 0x70)

4. **PWM:**
   - Проверить осциллографом сигналы на GPIO2/GPIO3
   - Должны быть импульсы 1-2 мс, частота 50 Hz

5. **RC-in:**
   - Проверить сигналы с приёмника на GPIO4/GPIO5

## Безопасность

⚠️ **ВАЖНО:**
- Всегда проверяйте failsafe перед первым запуском
- Убедитесь, что при потере связи ESC получает нейтральный сигнал
- Используйте предохранители на линиях питания
- Не подключайте/отключайте компоненты при включенном питании
- Проверяйте полярность батареи перед подключением

