# Роудмап системы стабилизации

Роудмап разработки системы стабилизации для RC-машины с использованием IMU и датчиков скорости.

## Цели системы стабилизации

- **Контроль рыскания (Yaw Rate Control)**: предотвращение неконтролируемых разворотов и заносов
- **Антипробуксовка (Traction Control)**: контроль пробуксовки колёс при ускорении
- **Стабилизация на склонах**: компенсация наклона при движении по неровной поверхности
- **Плавность управления**: фильтрация резких команд и вибраций

## Фазы разработки

### Фаза 0: Подготовка и анализ (MVP+)

**Цель**: Подготовить инфраструктуру для стабилизации, не нарушая базовую функциональность.

**Задачи**:
- [ ] Обеспечить стабильное чтение IMU на частоте ≥200 Гц на RP2040
- [ ] Реализовать базовую фильтрацию данных IMU (комплементарный фильтр или Madgwick)
- [ ] Добавить конфигурационные параметры стабилизации в протокол UART
- [ ] Создать режим "стабилизация выключена" (прямая передача команд)
- [ ] Добавить статус стабилизации в телеметрию

**Критерии готовности**:
- IMU читается стабильно на 200+ Гц без пропусков
- Данные IMU фильтруются и доступны в телеметрии
- Режим стабилизации можно включать/выключать через конфигурацию
- Без стабилизации система работает как раньше

**Оценка**: 1-2 недели

---

### Фаза 1: Базовый контроль рыскания (Yaw Rate Assist)

**Цель**: Предотвращение неконтролируемых разворотов при резких манёврах.

**Задачи**:
- [ ] Реализовать ПИД-регулятор для контроля угловой скорости по оси Z (yaw rate)
- [ ] Добавить настройки ПИД (Kp, Ki, Kd) через конфигурацию
- [ ] Интегрировать коррекцию руля на основе ошибки yaw rate
- [ ] Добавить ограничение максимальной коррекции (safety limit)
- [ ] Реализовать плавное включение/выключение стабилизации

**Технические детали**:
- Целевая частота регулятора: 200-500 Гц
- Источник данных: гироскоп (gyro Z) из IMU
- Выход: коррекция команды руля (steer correction)
- Формула: `steer_corrected = steer_command + PID(yaw_rate_error)`

**Критерии готовности**:
- При резком повороте система компенсирует избыточное вращение
- Настройки ПИД можно менять без перепрошивки
- Стабилизация не мешает нормальному управлению
- Тесты на ровной поверхности показывают улучшение стабильности

**Оценка**: 2-3 недели

---

### Фаза 2: Интеграция датчиков скорости (Traction Control)

**Цель**: Контроль пробуксовки колёс при ускорении.

**Задачи**:
- [ ] Разработать схему подключения датчиков Холла на колёса/кардан
- [ ] Реализовать чтение скорости с датчиков (минимум 1 датчик для начала)
- [ ] Добавить расчёт пробуксовки: сравнение скорости колёс с ожидаемой скоростью
- [ ] Реализовать ПИД-регулятор для контроля пробуксовки
- [ ] Интегрировать коррекцию газа при обнаружении пробуксовки

**Технические детали**:
- Минимум: 1 датчик на задний кардан (общая скорость)
- Идеал: 2-4 датчика (по колёсам) для дифференциального контроля
- Частота чтения: ≥100 Гц
- Алгоритм: сравнение `wheel_speed` с `expected_speed` (на основе команды газа)

**Критерии готовности**:
- Система обнаруживает пробуксовку при резком старте
- Газ автоматически снижается при пробуксовке
- Настройки можно менять через конфигурацию
- Работает совместно с yaw rate control

**Оценка**: 3-4 недели (включая установку датчиков)

---

### Фаза 3: Стабилизация на склонах (Pitch/Roll Compensation)

**Цель**: Компенсация наклона при движении по неровной поверхности.

**Задачи**:
- [ ] Использовать акселерометр для определения наклона (pitch/roll)
- [ ] Реализовать фильтрацию наклона (убрать влияние ускорения от движения)
- [ ] Добавить коррекцию газа при движении вверх/вниз по склону
- [ ] Добавить коррекцию руля при боковом наклоне (опционально)

**Технические детали**:
- Источник: акселерометр + комплементарный фильтр с гироскопом
- Компенсация: коррекция базовой команды газа на основе pitch
- Ограничение: максимальная коррекция не более 20-30% от команды

**Критерии готовности**:
- При движении вверх по склону газ автоматически увеличивается
- При движении вниз газ уменьшается
- Система не мешает нормальному управлению на ровной поверхности

**Оценка**: 2-3 недели

---

### Фаза 4: Продвинутые алгоритмы

**Цель**: Улучшение качества стабилизации и добавление новых возможностей.

**Задачи**:
- [ ] Адаптивные ПИД-параметры (изменение в зависимости от скорости/режима)
- [ ] Предсказание поведения (простые модели для предупреждения заноса)
- [ ] Режимы стабилизации (спорт/обычный/снег/грязь)
- [ ] Логирование данных для анализа и настройки
- [ ] Интеграция с веб-интерфейсом для настройки параметров

**Критерии готовности**:
- Пользователь может выбирать режимы стабилизации
- Параметры можно настраивать через веб-интерфейс
- Система адаптируется к условиям движения

**Оценка**: 4-6 недель

---

## Технические требования

### Аппаратные требования

**Минимальные (Фаза 1)**:
- IMU (MPU-6500) — уже есть
- RP2040 — уже есть
- Стабильное питание 3.3V для IMU

**Для Фазы 2+**:
- Датчики Холла (минимум 1, желательно 2-4)
- Магниты для установки на колёса/кардан
- Дополнительные GPIO на RP2040 для чтения датчиков

### Программные требования

- Частота чтения IMU: ≥200 Гц (желательно 500 Гц)
- Частота обновления регуляторов: 200-500 Гц
- Задержка от команды до коррекции: <10 мс
- Память для буферов данных: ~2-4 КБ

### Протоколы и интерфейсы

**Расширение протокола UART** (см. `docs/interfaces_protocols.md`):
- Новый тип кадра: `CONFIG_STABILIZATION` — настройка параметров стабилизации
- Новый тип кадра: `TELEM_STABILIZATION` — телеметрия стабилизации (статус, ошибки, коррекции)

**Расширение WebSocket**:
- Команда включения/выключения стабилизации
- Настройка параметров ПИД через веб-интерфейс
- Отображение статуса стабилизации в телеметрии

## Интеграция с существующей системой

### RP2040 (firmware/rp2040/)

**Новые модули**:
- `stabilization/` — основная логика стабилизации
  - `yaw_rate_control.hpp/cpp` — контроль рыскания
  - `traction_control.hpp/cpp` — контроль пробуксовки
  - `pid_controller.hpp/cpp` — универсальный ПИД-регулятор
  - `imu_filter.hpp/cpp` — фильтрация данных IMU
  - `wheel_speed_sensor.hpp/cpp` — чтение датчиков скорости

**Изменения в существующих модулях**:
- `pwm_control.cpp` — применение коррекций от стабилизации
- `imu_reader.cpp` — обеспечение высокой частоты чтения
- `protocol.cpp` — поддержка новых типов кадров

### ESP32 (firmware/esp32/)

**Изменения**:
- Веб-интерфейс: добавление панели настройки стабилизации
- WebSocket: поддержка команд и телеметрии стабилизации
- UART мост: прозрачная передача новых типов кадров

## Тестирование и валидация

### Фаза 1 (Yaw Rate Control)
- [ ] Тест на ровной поверхности: резкий поворот без стабилизации vs с стабилизацией
- [ ] Тест на скользкой поверхности: контроль заноса
- [ ] Тест безопасности: отключение стабилизации не должно вызывать рывков

### Фаза 2 (Traction Control)
- [ ] Тест на скользкой поверхности: старт с пробуксовкой
- [ ] Тест на ровной поверхности: нормальное ускорение не должно ограничиваться
- [ ] Тест совместной работы с yaw rate control

### Фаза 3 (Pitch/Roll Compensation)
- [ ] Тест на склоне: движение вверх/вниз
- [ ] Тест на неровной поверхности: компенсация бокового наклона

### Общие тесты
- [ ] Производительность: задержки не превышают требования
- [ ] Надёжность: система работает стабильно при длительной работе
- [ ] Failsafe: при сбое стабилизации система переходит в безопасный режим

## Риски и ограничения

### Технические риски
- **Вибрации**: IMU может давать шумные данные из-за вибраций шасси
  - *Митигация*: качественная фильтрация, жёсткое крепление IMU
- **Задержки**: высокая частота обработки может вызвать задержки в основном цикле
  - *Митигация*: оптимизация кода, использование DMA для I2C
- **Память**: дополнительные буферы могут не поместиться в RAM RP2040
  - *Митигация*: оптимизация структур данных, использование статических буферов

### Ограничения
- Стабилизация не заменяет хорошую механику (подвеска, шины)
- На очень высоких скоростях эффективность может снижаться
- Требуется настройка параметров под конкретную машину и условия

## Приоритизация

**Высокий приоритет** (MVP+):
- Фаза 0: Подготовка
- Фаза 1: Yaw Rate Control

**Средний приоритет**:
- Фаза 2: Traction Control (требует дополнительного железа)

**Низкий приоритет** (nice to have):
- Фаза 3: Pitch/Roll Compensation
- Фаза 4: Продвинутые алгоритмы

## Ссылки на документацию

- Основное ТЗ: `docs/ts.md`
- Протоколы: `docs/interfaces_protocols.md`
- Тайминги: `docs/firmware_timing.md`
- Стиль кода: `docs/cpp_coding_style.md`
- Глоссарий: `docs/glossary_ru.md`

## История изменений

- **2024-XX-XX**: Создан первоначальный роудмап
