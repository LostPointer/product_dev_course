# Тайминги и частоты для прошивок (MVP)

## Оптимальные значения для MVP

### RP2040 (real-time контроллер)

#### PWM генерация
- **Частота PWM**: **50 Hz** (период 20 мс)
  - Стандарт для RC серво и ESC
  - Достаточно для плавного управления
  - Можно увеличить до 100 Hz для более отзывчивого управления (опционально)

#### RC-in (чтение сигналов с приёмника)
- **Частота опроса**: **50 Hz**
  - Соответствует стандартной частоте RC-сигналов
  - Достаточно для плавного управления
  - Таймаут потери сигнала: **250 мс** (как в требованиях)

#### IMU (MPU-6500)
- **Частота чтения**: **50 Hz**
  - Достаточно для телеметрии в MVP
  - Для стабилизации/контроля заноса потребуется 200-500 Hz (позже)
  - Интерфейс: I2C (обычно 400 kHz)

#### UART (ESP32 ↔ RP2040)
- **Скорость**: **115200 baud** (для MVP)
  - Достаточно для передачи команд и телеметрии
  - Можно увеличить до 921600 baud для более быстрой передачи (опционально)
- **Частота отправки команд**: **50 Hz** (каждые 20 мс)
- **Частота отправки телеметрии**: **20 Hz** (каждые 50 мс)
  - Меньше нагрузки на канал, достаточно для отображения

#### Failsafe
- **Таймаут потери активного источника**: **250 мс**
  - Как указано в требованиях
  - После таймаута: газ=0, руль=центр

#### Slew-rate limiting (плавность)
- **Максимальная скорость изменения газа**: **0.5 за секунду** (опционально)
- **Максимальная скорость изменения руля**: **1.0 за секунду** (опционально)

---

### ESP32-S3 (Wi-Fi контроллер)

#### Wi-Fi
- **Режим**: Access Point (AP)
- **SSID**: `RC-Vehicle-XXXX` (где XXXX - последние 4 символа MAC)
- **Канал**: автоматический выбор
- **Максимальное количество клиентов**: 4 (для MVP достаточно)

#### HTTP сервер
- **Порт**: 80
- **Раздача веб-интерфейса**: статические файлы (HTML/CSS/JS)
- **Keep-alive**: включено для снижения задержек

#### WebSocket сервер
- **Порт**: 81 (или через HTTP upgrade на порту 80)
- **Частота приёма команд**: **до 100 Hz** (как в протоколе)
  - Ограничение на стороне клиента (браузер)
  - Реальная частота обычно 30-60 Hz
- **Частота отправки телеметрии**: **20 Hz** (каждые 50 мс)
  - Баланс между отзывчивостью и нагрузкой
  - Достаточно для плавного отображения в UI

#### UART (ESP32 ↔ RP2040)
- **Скорость**: **115200 baud** (совпадает с RP2040)
- **Частота отправки команд**: **50 Hz** (каждые 20 мс)
  - Синхронизировано с частотой PWM на RP2040
- **Частота приёма телеметрии**: **20 Hz** (каждые 50 мс)
  - Синхронизировано с частотой отправки с RP2040

#### Буферизация
- **Размер буфера команд**: 2-3 команды (на случай задержек)
- **Размер буфера телеметрии**: 2-3 пакета
- **Таймаут ожидания ответа**: 100 мс

---

## Сводная таблица частот

| Компонент | Частота | Период | Примечание |
|-----------|---------|--------|------------|
| PWM (ESC/серво) | 50 Hz | 20 мс | Стандарт RC |
| RC-in опрос | 50 Hz | 20 мс | Соответствует RC-сигналам |
| IMU чтение | 50 Hz | 20 мс | Достаточно для телеметрии |
| Телеметрия (RP2040→ESP32) | 20 Hz | 50 мс | Баланс нагрузка/отзывчивость |
| Команды (ESP32→RP2040) | 50 Hz | 20 мс | Синхронизировано с PWM |
| WebSocket команды (браузер→ESP32) | до 100 Hz | 10 мс | Ограничение браузера |
| WebSocket телеметрия (ESP32→браузер) | 20 Hz | 50 мс | Плавное отображение |
| Failsafe таймаут | - | 250 мс | Требование безопасности |

---

## Рекомендации по оптимизации

### Для MVP (текущий план)
- Использовать предложенные значения
- Фокус на стабильности и простоте

### Для будущих улучшений
- **PWM**: можно увеличить до 100-200 Hz для более плавного управления
- **IMU**: увеличить до 200-500 Hz для стабилизации/контроля заноса
- **UART**: увеличить скорость до 921600 baud для снижения задержек
- **Телеметрия**: увеличить до 50 Hz для более детального логирования

---

## Задержки (latency) - целевые значения

- **Браузер → ESP32 (WebSocket)**: < 10 мс (локальная сеть)
- **ESP32 → RP2040 (UART)**: < 5 мс (115200 baud)
- **RP2040 обработка команды**: < 1 мс
- **Общая задержка (браузер → PWM)**: **< 100 мс** (требование MVP)

