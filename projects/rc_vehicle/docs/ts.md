# Техническое задание (кратко): ретрофит RC‑машины под STM32 + IMU + Wi‑Fi + RC‑пульт

## 1) Цель
Собрать бортовой контроллер для RC‑машины, который обеспечивает:
- ручное управление **с RC‑пульта** и **со смартфона по Wi‑Fi**,
- чтение **IMU (акселерометр+гироскоп)** и вывод телеметрии,
- безопасное поведение при потере связи (**failsafe**),
- возможность последующего апгрейда датчиками скорости (Холл) для более “настоящего” контроля пробуксовки.

База (шасси): **Himoto SCT‑16 4WD RTR 1:16 2.4G (HI4192|RED)** — см. карточку: [Яндекс Маркет](https://market.yandex.ru/card/radioupravlyayemyy-short-kors-trak-himoto-sct-16-4wd-rtr-masshtab-116-24g---hi4192red/4399880474?do-waremd5=9jRAzA7SdRMQfoiYw52cAw&cpc=d2PGwzy0QTs0eLnRlKp0k5YCu2JHodVzFJDvJtshUWzSyDz3E9FKzWqRWc9gIULXX9EJ9Ku-0mvQsCTCCBzwqE-a6FjyS4PfsjEQ8zw1WU-FqmGO5HghkO4aplP4qdbhCmxXetVCLQqycN6o03nHXP_tLSTfOP2glbQ73t_oCvPUAJbjP6PtzyvAx9EZdLsM_MZD6JCx9hF2cmhA0Yc88aMXOZ_Ei1IVvZjbvcsvgHDewTubfOP7WxmSPsCnzZvbiXsTE30oPZ2PX6ct5WAkjK3DLf9791pMdJqhKAAkwv7LcDElOfELc6S0wxkUen63wrtSxWiKAo38hVIlcprRM84HQu9ao5TKsC9LjxYBM0hP5J5NaEfI0IHukClWKjyg9bwUETyJZKEokhHrUvGdfPVfDCgSMMCBr0cFhxl4T4GRgdt4k6KP_xjqOGhNoV-7&ogV=-9). Бюджет базы: **≤10k₽**.

## 2) Архитектура (ветка A)
Ветка A: остаются штатные **ESC** и **рулевая серво**, управляющие сигналы — стандартный **PWM**.

- **STM32**: главный real‑time контроллер (PWM на ESC/серво, чтение RC‑входа, IMU, failsafe, телеметрия).
- **ESP32**: Wi‑Fi точка доступа + веб‑пульт + мост (WebSocket → UART → STM32).
- **RC‑приёмник**: второй источник управления (PWM/PPM/SBUS), приоритет над Wi‑Fi.

## 3) Требования к железу
- **MCU**: STM32F4 (рекомендуется BlackPill STM32F411).
- **Wi‑Fi**: ESP32 (DevKit или компактная плата).
- **IMU**:
  - MVP: MPU‑6050 допустимо,
  - предпочтительно: LSM6DSO или BMI270.
- **Питание**:
  - 5V (BEC от ESC или отдельный DC‑DC) для ESP32/серво,
  - 3.3V для STM32/IMU (от стабилизатора платы или отдельный 3.3V DC‑DC/LDO),
  - обязательны развязка и конденсаторы на 5V шине.

### Обязательные “маркер‑условия” для ветки A (по базе)
- серво руля: **3 провода** (Signal/5V/GND),
- управление ESC: **стандартный PWM вход** (как от RC‑приёмника),
- предпочтительно: отдельные разъёмы `CH1/CH2` или `STR/THR`.

Подтверждение по факту (Himoto SCT‑16, по фото): есть отдельный RC‑приёмник **Himoto 2.4GHz 4CH** с 3‑pin разъёмами `CH1..CH4` → PWM совместимость ветки A выглядит подтверждённой.

## 4) Функциональные требования (MVP)
### Управление
- **RC‑режим**: чтение 2 каналов (THR/STR) и управление ESC/серво.
- **Wi‑Fi‑режим**: управление из браузера (WebSocket) через ESP32.
- **Приоритет**: RC > Wi‑Fi.
- **Плавность**: ограничения на скорость изменения (slew‑rate limit) для газа/руля (включаемо).

### IMU и телеметрия
- Считывание акселерометра/гироскопа.
- Отправка телеметрии в веб‑пульт (минимум: accel/gyro, статус связи).

### Безопасность
- Failsafe при потере активного источника > 250 мс: **газ=0/нейтраль**, **руль=нейтраль**.
- Нейтраль/лимиты PWM настраиваемы.

## 5) Интерфейсы и протоколы
Использовать текущую спецификацию из `docs/interfaces_protocols.md`:
- WebSocket команда: `thr,steer` в диапазоне `[-1..1]`.
- UART кадры ESP32↔STM32: `AA 55 ... CRC16` (COMMAND/TELEM).

## 6) Нефункциональные требования
- Управление: задержка от браузера до PWM не более ~100 мс в нормальных условиях (MVP‑уровень).
- Устойчивость к помехам от ESC/серво: питание и земля разведены корректно, связь по UART не “сыпется”.
- Простота обслуживания: модульное крепление плат (двусторонний скотч/стойки), доступ к разъёмам.

## 7) Критерии приёмки (Definition of Done)
- Машина управляется с **RC‑пульта** и **по Wi‑Fi** (оба направления).
- При отключении Wi‑Fi/RC система уходит в **failsafe** за ≤250 мс.
- IMU данные видны в телеметрии и обновляются.
- Переключение источников управления не вызывает “внезапного газа”.

## 8) Опциональные расширения (после MVP)
- Датчик(и) Холла на спур/кардан (скорость/одометрия).
- Yaw‑rate assist (антиразворот) по гироскопу.
- Логирование телеметрии.


