# Пошаговый план работ (без кода) — ретрофит готовой RC‑машины

Цель: получить машину, которая управляется **со смартфона по Wi‑Fi** и **с RC‑пульта**, с телеметрией IMU и безопасным поведением при потере связи.
Термины/сокращения: см. `docs/glossary_ru.md`.

## 0) До покупки базы (самое важное)
- Открыть `docs/car_candidates_ru.md` и выбрать 1–2 семейства, которые вам нравятся по типу (краулер/пикап/шорт‑корс).
- Принять стратегию:
  - **Ветка A (выбрана)**: база должна позволять управлять штатным регулятором (ESC) и рулевым сервоприводом через **классический PWM** (как от обычного RC‑приёмника).
  - **Ветка B (план‑B)**: если выяснится, что штатная плата не имеет стандартных входов/разъёмов и “врезаться” в PWM нельзя — готовим замену электроники на стандартные узлы.

## 1) Закупка электроники (параллельно с покупкой машинки)
- По списку из `docs/bom_ru.md`.
- Сверить общий бюджет по `docs/budget_ru.md` (особенно если добавляете RC‑пульт+приёмник).

### Статус закупки (см. `docs/bom_ru.md`)
✅ **Уже куплено:**
- RP2040 (Raspberry Pi Pico Black Board) — real‑time контроллер
- ESP32‑S3 Zero mini — Wi‑Fi контроллер
- MPU‑6500 — IMU (акселерометр + гироскоп)
- BEC ReadyToSky 2–6S 5V/12V 3A — источник питания

❌ **Осталось купить:**
- Конденсаторы для стабилизации 5V (470–1000µF + 0.1µF)
- Соединители и проводка (servo разъёмы, JST, провода Dupont, термоусадка, стяжки)
- Делители напряжения (если RC‑приёмник выдаёт 5V сигналы)
- Мультиметр (желательно)
- Двусторонний скотч/липучка

## 2) Первичная диагностика после покупки (10–15 минут)
- Снять кузов и зафиксировать:
  - есть ли **отдельный рулевой сервопривод** (3 провода)?
  - мотор **brushed (2 провода)** или **brushless (3 провода)**?
  - есть ли понятные разъёмы / возможность подать PWM на газ/руль?
  - как организовано питание (есть ли BEC 5V и где его брать)?

Результат: окончательно выбрать ветку **A** или **B**.

### Результат диагностики по Himoto SCT‑16 (по фото)
- Есть отдельный **RC‑приёмник Himoto 2.4GHz 4CH** с обычными 3‑pin разъёмами `CH1..CH4` → это означает **стандартный PWM** и хорошую совместимость с веткой A.
- Отдельный ESC установлен отдельно от приёмника (не “комбо‑плата”) → проще “врезаться” между приёмником и ESC/серво.

#### Фото (в репозитории)
Сложите диагностические фото в `docs/media/` и используйте эти имена:
- `docs/media/himoto_sct16_internals_esc_rx.jpg` — ESC + общая компоновка
- `docs/media/himoto_sct16_receiver_ch.jpg` — приёмник Himoto 4CH (CH1..CH4)

Ссылки (начнут отображаться, когда файлы будут добавлены в репозиторий):
- ![Himoto SCT‑16: компоновка, ESC и приёмник](media/himoto_sct16_internals_esc_rx.jpg)
- ![Himoto SCT‑16: приёмник Himoto 4CH, разъёмы CH1..CH4](media/himoto_sct16_receiver_ch.jpg)

## 3) Электрическая интеграция
### Ветка A
- Подать PWM с **RP2040** на штатный ESC и рулевой сервопривод (или на входы `THR/STR`, если они есть).
- RP2040 генерирует PWM сигналы для ESC (газ) и серво (руль).
- Подключить **BEC ReadyToSky** к батарее 2S, выставить режим 5V.
- Питать ESP32‑S3 и RP2040 от BEC (5V).
- Добавить конденсаторы на шину 5V (470–1000µF + 0.1µF) для стабилизации.

### Ветка B
- Заменить штатную плату на стандартные узлы:
  - ESC (brushed или brushless — по вашему мотору) + BEC 5V
  - (при необходимости) рулевой сервопривод

## 4) Два источника управления
- **Wi‑Fi управление**: телефон → ESP32‑S3 Zero mini (AP/точка доступа) → UART → RP2040.
- **RC управление**: RC‑приёмник → RP2040 (PWM входы, при необходимости через делители напряжения если сигнал 5V).
- Задать правило приоритета и безопасный таймаут (failsafe) — см. `docs/interfaces_protocols.md`.
- Примечание: RP2040 работает на 3.3V логике, поэтому если RC‑приёмник выдаёт 5V PWM, нужны делители напряжения или level‑shifter.

## 5) IMU
- Установить **MPU‑6500** на шасси жёстко (минимум вибраций), согласовать оси.
- Подключить MPU‑6500 к RP2040 по I2C (обычно SDA/SCL).
- Для начала достаточно: чтение accel/gyro и вывод в телеметрию через ESP32‑S3; дальше можно добавлять режимы стабилизации.
- Примечание: MPU‑6500 работает от 3.3–5V, можно питать от 3.3V с RP2040 или от 5V шины.

Если вы целитесь в **устойчивость/контроль заноса**, то на практике потребуется:
- высокая частота чтения IMU и управления (ориентир: 200–500 Гц для контуров по gyro),
- хорошие шины/подвеска (это “бесплатная” стабильность),
- (опционально, но сильно помогает) датчики скорости колёс/одометрия, если захочется контролировать пробуксовку, а не только рыскание.

## 6) (Опционально, позже) Датчики скорости колёс
- Заложить места под датчики заранее: где можно закрепить магнит и датчик (на кардане/спуре/ступице), чтобы проводка не цеплялась за подвеску.
- Начать можно с **1 датчика** (общая “скорость”), а затем расширить до 2–4 датчиков (по колёсам) — это уже даёт основу для контроля пробуксовки.

## 7) Тесты безопасности (обязательно)
- Потеря Wi‑Fi → газ в ноль/нейтраль.
- Потеря RC → газ в ноль/нейтраль.
- Переключение источников управления → без рывка/без “внезапного газа”.
